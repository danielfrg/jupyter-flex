# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2

orbs:
  conda: deepgenomics/conda@10.0.0

jobs:
  build:
    docker:
      - image: circleci/python:3.7.6-browsers

    working_directory: ~/repo

    steps:
      - checkout

      - conda/install-conda

      - conda/restore-conda:
          key: v1-conda-env-{{ arch }}-{{ checksum "environment.yml" }}

      - conda/save-conda:
          key: v1-conda-env-{{ arch }}-{{ checksum "environment.yml" }}
          steps:
            - run:
                name: Setup jupyter-flex dependencies
                command: |
                  conda env create --quiet --name jupyter-flex --file test-environment.yml

      # run tests
      - run:
          name: Install package
          command: |
            conda activate jupyter-flex
            python setup.py install

      - run:
          name: Start Voila
          command: |
            conda activate jupyter-flex
            voila --template flex --no-browser --port 8866 ~/repo/examples
          background: true

      - run:
          name: Run tests
          command: |
            conda activate jupyter-flex
            make test

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: test-results
